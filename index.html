<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fanfic Café - Avalie Histórias</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Open+Sans:wght{400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --cor-principal: #A0522D; 
            --cor-fundo: #F5F5DC; 
            --cor-fundo-card: #FCFCF4;
            --cor-texto: #333333; 
            --cor-destaque: #D2B48C; 
            --cor-forca: #333333; 
            --cor-sucesso: #4CAF50;
            --cor-erro: #F44336;
            --fonte-titulo: 'Merriweather', serif;
            --fonte-corpo: 'Open Sans', sans-serif;
        }
        /* Definições de Temas */
        .dark-mode { --cor-principal: #FFD700; --cor-fundo: #1E1E1E; --cor-fundo-card: #2B2B2B; --cor-texto: #E0E0E0; --cor-destaque: #5A5A5A; --cor-forca: #999999; --cor-sucesso: #66BB6A; --cor-erro: #EF5350; }
        .vermelho-claro { --cor-principal: #C82506; --cor-fundo: #FFEDED; --cor-fundo-card: #FFFFFF; --cor-texto: #333333; --cor-destaque: #FAA0A0; --cor-forca: #333333; }
        .vermelho-escuro { --cor-principal: #FF5733; --cor-fundo: #3A0000; --cor-fundo-card: #581C09; --cor-texto: #FFEDD5; --cor-destaque: #801818; --cor-forca: #E0E0E0; }
        .laranja-claro { --cor-principal: #E66000; --cor-fundo: #FFF5E0; --cor-fundo-card: #FFFFFF; --cor-texto: #333333; --cor-destaque: #FFCC99; --cor-forca: #333333; }
        .laranja-escuro { --cor-principal: #FFA040; --cor-fundo: #4D2600; --cor-fundo-card: #6D3D0A; --cor-texto: #FFEDD5; --cor-destaque: #995C00; --cor-forca: #E0E0E0; }
        .amarelo-claro { --cor-principal: #D4A300; --cor-fundo: #FFFFE0; --cor-fundo-card: #FFFFFF; --cor-texto: #333333; --cor-destaque: #FFFF99; --cor-forca: #333333; }
        .amarelo-escuro { --cor-principal: #FFE54C; --cor-fundo: #3D3D00; --cor-fundo-card: #575705; --cor-texto: #FFEDD5; --cor-destaque: #8F8F00; --cor-forca: #E0E0E0; }
        .verde-claro { --cor-principal: #008000; --cor-fundo: #E0FFE0; --cor-fundo-card: #FFFFFF; --cor-texto: #333333; --cor-destaque: #99FF99; --cor-forca: #333333; }
        .verde-escuro { --cor-principal: #4CFF4C; --cor-fundo: #003300; --cor-fundo-card: #0A4D0A; --cor-texto: #E0FFE0; --cor-destaque: #006600; --cor-forca: #E0E0E0; }
        .azul-claro { --cor-principal: #0000FF; --cor-fundo: #E0E0FF; --cor-fundo-card: #FFFFFF; --cor-texto: #333333; --cor-destaque: #9999FF; --cor-forca: #333333; }
        .azul-escuro { --cor-principal: #5C5CFF; --cor-fundo: #000033; --cor-fundo-card: #0A0A4D; --cor-texto: #E0E0FF; --cor-destaque: #000066; --cor-forca: #E0E0E0; }
        .anil-claro { --cor-principal: #4B0082; --cor-fundo: #F0E6FF; --cor-fundo-card: #FFFFFF; --cor-texto: #333333; --cor-destaque: #C3B1E1; --cor-forca: #333333; }
        .anil-escuro { --cor-principal: #B8A0E8; --cor-fundo: #240040; --cor-fundo-card: #3A105C; --cor-texto: #F0E6FF; --cor-destaque: #4A1A70; --cor-forca: #E0E0E0; }
        .violeta-claro { --cor-principal: #EE82EE; --cor-fundo: #FFEEFF; --cor-fundo-card: #FFFFFF; --cor-texto: #333333; --cor-destaque: #FFCCFF; --cor-forca: #333333; }
        .violeta-escuro { --cor-principal: #FF99FF; --cor-fundo: #330033; --cor-fundo-card: #4D0A4D; --cor-texto: #FFEEFF; --cor-destaque: #660066; --cor-forca: #E0E0E0; }
        .pb-claro { --cor-principal: #000000; --cor-fundo: #FFFFFF; --cor-fundo-card: #FFFFFF; --cor-texto: #000000; --cor-destaque: #DDDDDD; --cor-forca: #000000; }
        .pb-escuro { --cor-principal: #FFFFFF; --cor-fundo: #000000; --cor-fundo-card: #111111; --cor-texto: #FFFFFF; --cor-destaque: #333333; --cor-forca: #FFFFFF; }

        /* Estilos Globais e de Base */
        body { 
            font-family: var(--fonte-corpo); 
            background-color: var(--cor-fundo); 
            color: var(--cor-texto); 
            margin: 0; 
            padding: 0; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            transition: background-color 0.5s, color 0.5s; 
            line-height: 1.6; 
        }
        header { 
            width: 100%; 
            padding: 20px; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            background-color: var(--cor-fundo-card); 
            z-index: 50; 
        }
        main { 
            width: 95%; 
            max-width: 900px; 
            padding-bottom: 50px; 
            padding-top: 20px;
        }
        h1, h2, h3 { 
            color: var(--cor-principal) !important; 
            font-family: var(--fonte-titulo); 
            transition: color 0.5s; 
        }
        button, .btn { 
            background-color: var(--cor-principal); 
            color: var(--cor-fundo); 
            border: none; 
            padding: 12px 25px; 
            margin: 5px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: background-color 0.3s, color 0.3s, transform 0.1s; 
            font-family: var(--fonte-corpo); 
            font-weight: 600; 
            width: auto; 
            text-transform: uppercase; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        button:hover, .btn:hover { 
            background-color: var(--cor-destaque); 
            color: var(--cor-principal); 
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .estrela { color: gold; cursor: pointer; transition: color 0.1s; }
        
        /* Estilos de Formulário */
        .historia-card { 
            background-color: var(--cor-fundo-card); 
            border: 1px solid var(--cor-destaque); 
            transition: background-color 0.5s; 
        }
        input, textarea { 
            border: 1px solid var(--cor-forca) !important; 
            color: var(--cor-texto); 
            background-color: var(--cor-fundo-card); 
            padding: 12px; 
            margin: 5px 0 15px 0; 
            border-radius: 8px; 
            width: 100%; 
            box-sizing: border-box; 
            font-size: 1em; 
        }
        textarea { resize: vertical; } 
        
        /* Popup/Modal - Implementação do Acúmulo de Telas */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: rgba(0,0,0,0.7); 
            padding: 0; 
        }
        .modal.ativo { display: block; } /* Certifica-se de que o modal está visível ao ser ativado */
        
        .modal-content { 
            margin: 0; 
            padding: 0; 
            border-radius: 0;
            width: 100%; 
            height: 100%; 
            max-width: unset; 
            box-shadow: none; 
            
            /* Flexbox para estrutura (Header + Body) */
            display: flex; 
            flex-direction: column;
            
            position: absolute; 
            top: 0;
            left: 0;
            z-index: 101; 
            
            background-color: var(--cor-fundo-card); 
            transition: transform 0.3s ease-out; 
            transform: translateX(100%); /* Escondido inicialmente fora da tela */
            overflow: hidden; 
        }
        
        /* Efeito de abertura - A chave para o slide-in */
        .modal.ativo .modal-content {
            transform: translateX(0); 
        }

        /* Barra de Navegação (Header Falso) */
        .modal-content-header {
            background-color: var(--cor-principal);
            color: var(--cor-fundo);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px;
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1; 
        }
        
        .modal-content-header h2 {
            color: var(--cor-fundo) !important; 
            margin: 0;
            font-size: 1.2em;
            flex-grow: 1;
            text-align: center;
        }

        /* Botão Voltar/Fechar (Cruz) */
        .modal-content-header .fechar {
            order: -1; 
            color: var(--cor-fundo); 
            font-size: 1.5em; 
            font-weight: normal; 
            cursor: pointer;
            line-height: 1;
            margin-right: 15px;
        }

        /* Corpo do Conteúdo - Rola Aqui */
        .modal-content-body {
            padding: 20px;
            overflow-y: auto; 
            flex-grow: 1; 
        }
        
        /* Botões Padrões (Login/Registro/Etc) - Retirados do fluxo de acúmulo */
        #login-cadastro-popup .modal-content, 
        #editar-perfil-popup .modal-content,
        #criar-post-popup .modal-content, 
        #placar-popup .modal-content,
        #temas-popup .modal-content,
        #notificacoes-popup .modal-content {
            height: auto; 
            min-height: 200px;
            max-width: 500px; 
            margin: 5% auto; 
            padding: 30px; 
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            transform: none; /* Não aplica o slide-in para estes modais menores/tradicionais */
            position: relative;
            /* Flexbox desativado e substituído pelo display block/padding tradicional */
            display: block; 
            overflow: visible;
        }
        /* Ajuste de conteúdo para modais tradicionais */
        #login-cadastro-popup .modal-content .fechar, 
        #editar-perfil-popup .modal-content .fechar,
        #criar-post-popup .modal-content .fechar,
        #placar-popup .modal-content .fechar,
        #temas-popup .modal-content .fechar,
        #notificacoes-popup .modal-content .fechar {
            float: right;
            order: initial;
            color: var(--cor-texto); 
        }


        /* Ícone de Fechar para modais tradicionais */
        .fechar { 
            color: var(--cor-texto); 
            float: right; 
            font-size: 32px; 
            font-weight: bold; 
        }
        .fechar:hover, .fechar:focus { 
            color: var(--cor-principal); 
            text-decoration: none; 
            cursor: pointer; 
        }
        
        /* Notificações (Sino) */
        #notificacoes { 
            position: fixed; 
            top: 15px; 
            right: 15px; 
            background-color: var(--cor-principal); 
            color: var(--cor-fundo); 
            padding: 10px 15px; 
            border-radius: 50%; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.4); 
            cursor: pointer; 
            z-index: 110; 
            font-size: 1.2em;
            line-height: 1;
            width: 40px; 
            height: 40px; 
            display: none; 
            align-items: center;
            justify-content: center;
        }
        #contador-notificacoes {
             position: absolute;
             top: -5px;
             right: -5px;
             background-color: var(--cor-erro);
             color: white;
             font-size: 0.7em;
             padding: 3px 6px;
             border-radius: 50%;
             min-width: 15px;
             text-align: center;
        }

        /* Containers de Grid (Histórias) */
        #lista-publicacoes, #destaques-container, #minhas-historias-container, #publico-historias-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 25px; 
            margin-top: 25px; 
        }
        .historia-card { 
            border-radius: 10px; 
            padding: 15px; 
            text-align: center; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .historia-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }
        .historia-card img { 
            width: 100%; 
            height: 180px; 
            object-fit: cover; 
            border-radius: 6px; 
            margin-bottom: 10px; 
        }
        
        /* Input Group (Senha) */
        .input-group { position: relative; width: 100%; margin: 5px 0 15px 0; display: inline-block;}
        .input-group input { width: 100%; padding-right: 40px; }
        .toggle-senha { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--cor-forca); font-size: 1.1em; }

        /* Botões de Acesso Principal */
        #botoes-acesso { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 15px; 
            margin-top: 30px;
        }
        #botoes-acesso button {
            flex-grow: 1; 
            min-width: 180px; 
            max-width: 280px; 
        }

        /* Botões de Ação da História (4 botões: Curtir, Comentar, Compartilhar, Denunciar) */
        #acoes-historia {
            display: flex;
            flex-wrap: wrap; 
            justify-content: space-between; 
            gap: 10px;
            margin-top: 15px;
        }
        #acoes-historia button {
            flex-basis: calc(50% - 5px); 
            margin: 0;
            min-width: 140px;
            padding: 10px 15px; 
        }
            
        /* Botoes de Autor (2 botões: Edição/Apagar) */
        #botoes-autor {
             display: flex; 
             flex-wrap: nowrap; 
             gap: 10px;
             margin-top: 10px;
             justify-content: space-between;
        }
        #botoes-autor button {
            flex-basis: calc(50% - 5px); 
            margin: 0;
        }

        /* Lista de Notificações */
        #lista-notificacoes { max-height: 400px; overflow-y: auto; }
        #lista-notificacoes li { 
            padding: 15px; 
            border-bottom: 1px solid var(--cor-destaque); 
            cursor: pointer; 
            transition: background-color 0.3s;
        }
        #lista-notificacoes li:hover { background-color: rgba(var(--cor-destaque), 0.1); }
        .notificacao-nao-lida { font-weight: bold; color: var(--cor-principal); }

        /* Áreas de Chat */
        .chat-area h3 { margin-bottom: 5px; }
        #mensagens-global, #mensagens-privadas { 
            border: 1px solid var(--cor-destaque); 
            height: 300px; 
            padding: 15px; 
            border-radius: 8px; 
            overflow-y: auto; 
            margin-bottom: 15px; 
            background-color: var(--cor-fundo-card);
        }
        /* Estilo para as conversas na lista */
        #lista-conversas li { 
            padding: 8px 0; 
            border-bottom: 1px dotted var(--cor-destaque); 
        }
        
        /* Media Query para Mobile (Telas de até 768px) */
        @media (max-width: 768px) { 
            main { width: 98%; padding: 10px; }
            
            /* Ocupação total para itens em grid (histórias) */
            #lista-publicacoes, #destaques-container, #minhas-historias-container, #publico-historias-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Ajuste para Leitura/Comentários dentro da nova estrutura modal */
            .modal-content-body #conteudo-livro {
                font-size: 1.1em; 
                line-height: 1.7;
            }

            /* Estilo dos Botões de Ação/Autor no Mobile */
            #acoes-historia button, #botoes-autor button {
                 flex-basis: calc(50% - 5px); 
                 min-width: unset; 
                 font-size: 0.9em;
            }

            /* Ajuste do Input e Botão no Chat (Global e Privado) */
            .chat-area input {
                width: calc(100% - 80px); 
                display: inline-block;
                vertical-align: middle;
                margin-bottom: 0;
                padding: 10px;
            }
            .chat-area button {
                width: 70px; 
                padding: 10px 5px;
                vertical-align: middle;
                margin: 0 0 5px 5px;
                font-size: 0.9em;
            }
            
            /* Ajuste visual do sino */
            #notificacoes { 
                padding: 10px;
                font-size: 1.3em;
                width: 45px;
                height: 45px;
            }
            #contador-notificacoes {
                 font-size: 0.8em;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1 style="font-family: var(--fonte-titulo);">Fanfic Café</h1>
        <p>Um lugar aconchegante para ler e avaliar novas histórias.</p>
    </header>

    <div id="notificacoes" onclick="carregarNotificacoes(); togglePopup('notificacoes-popup')">
        <i class="fas fa-bell"></i> <span id="contador-notificacoes">0</span>
    </div>
    
    <main id="tela-inicial">
        <div id="botoes-acesso">
            <button onclick="togglePopup('login-cadastro-popup')" id="btn-login-cadastro"><i class="fas fa-user-circle"></i> Login / Cadastro</button>
            <button onclick="togglePopup('perfil-pessoal-popup', true)" id="btn-meu-perfil" style="display:none;"><i class="fas fa-user"></i> Meu Perfil</button>
            <button onclick="togglePopup('publicacoes-popup', true)"><i class="fas fa-book-open"></i> Ver Histórias</button>
            <button onclick="togglePopup('chat-popup', true)" id="btn-chat" style="display:none;"><i class="fas fa-comments"></i> Chat Global/Privado</button>
            <button onclick="togglePopup('criar-post-popup', true)" id="btn-criar-post" style="display:none;"><i class="fas fa-pen-fancy"></i> Escrever História</button>
            <button onclick="togglePopup('placar-popup', true)"><i class="fas fa-trophy"></i> Placar de Perfis</button>
            <button onclick="fazerLogout()" id="btn-logout" style="display:none;"><i class="fas fa-sign-out-alt"></i> Sair</button>
            <button onclick="togglePopup('temas-popup', true)"><i class="fas fa-palette"></i> Temas</button>
        </div>

        <h2 style="font-family: var(--fonte-titulo); margin-top: 40px;">Destaques da Semana</h2>
        <div id="destaques-container">
        </div>
    </main>

    <div id="login-cadastro-popup" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharPopup('login-cadastro-popup')">&times;</span>
            <h2><i class="fas fa-user-circle"></i> Acesso ao Fanfic Café</h2>
            
            <h3>Fazer Login</h3>
            <input type="email" id="login-email" placeholder="E-mail">
            <div class="input-group">
                <input type="password" id="login-senha" placeholder="Senha">
                <span class="toggle-senha" onclick="toggleSenha('login-senha', 'toggle-login')"><i class="fas fa-eye" id="toggle-login"></i></span>
            </div>
            <button onclick="fazerLogin()"><i class="fas fa-sign-in-alt"></i> Entrar</button>

            <hr style="border-color: var(--cor-destaque); margin: 20px 0;">
            
            <h3>Novo por aqui? Cadastre-se</h3>
            <input type="email" id="cadastro-email" placeholder="Seu melhor E-mail">
            <div class="input-group">
                <input type="password" id="cadastro-senha" placeholder="Crie uma Senha (mín. 6 caracteres)">
                <span class="toggle-senha" onclick="toggleSenha('cadastro-senha', 'toggle-cadastro')"><i class="fas fa-eye" id="toggle-cadastro"></i></span>
            </div>
            <button onclick="fazerCadastro()"><i class="fas fa-user-plus"></i> Cadastrar</button>

            <p id="auth-mensagem" style="margin-top: 15px;"></p>
        </div>
    </div>
    
    <div id="editar-perfil-popup" class="modal">
        <div class="modal-content">
            <span class="fechar" onclick="fecharPopup('editar-perfil-popup')">&times;</span>
            <h2><i class="fas fa-pencil-alt"></i> Editar Meu Perfil</h2>
            <label for="edit-nome">Nome de Exibição:</label>
            <input type="text" id="edit-nome" maxlength="50" placeholder="Seu Nome"><br>
            
            <label for="edit-foto">Link da Foto de Perfil (Direto):</label>
            <input type="url" id="edit-foto" placeholder="http://linkdireto.com/sua-foto.jpg"><br>
            
            <label for="edit-descricao">Descrição (máx. 300 caracteres):</label>
            <textarea id="edit-descricao" maxlength="300" placeholder="Conte algo sobre você..." style="resize: none; height: 100px;"></textarea>
            
            <button onclick="salvarEdicaoPerfil()"><i class="fas fa-save"></i> Salvar Alterações</button>
        </div>
    </div>

    <div id="criar-post-popup" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="fechar" onclick="fecharPopup('criar-post-popup')">&times;</span>
            <h2><i class="fas fa-feather-alt"></i> Escreva Sua História</h2>
            
            <label for="post-titulo">Título da História:</label>
            <input type="text" id="post-titulo" placeholder="O título da sua obra"><br>
            
            <label for="post-capa">Link da Imagem de Capa (Direto):</label>
            <input type="url" id="post-capa" placeholder="http://linkdireto.com/sua-capa.jpg"><br>
            
            <label for="post-conteudo">Conteúdo da História:</label>
            <textarea id="post-conteudo" placeholder="Comece a escrever aqui... inclua links diretos de imagem ou vídeos do YouTube no texto." style="resize: vertical; height: 250px;"></textarea>
            
            <button onclick="publicarHistoria()"><i class="fas fa-upload"></i> Publicar</button>
        </div>
    </div>

    <div id="placar-popup" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="fechar" onclick="fecharPopup('placar-popup')">&times;</span>
            <h2><i class="fas fa-medal"></i> Placar dos Melhores Perfis</h2>
            
            <ol id="lista-placar" style="list-style-type: none; padding: 0;">
            </ol>
        </div>
    </div>
    
    <div id="temas-popup" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="fechar" onclick="fecharPopup('temas-popup')">&times;</span>
            <h2><i class="fas fa-palette"></i> Escolha Seu Tema</h2>
            
            <div id="selecao-temas" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px;">
                <button onclick="aplicarTema('cafe-claro')">Café Claro</button>
                <button onclick="aplicarTema('dark-mode')">Café Escuro</button>
                <button onclick="aplicarTema('vermelho-claro')">Vermelho Claro</button>
                <button onclick="aplicarTema('vermelho-escuro')">Vermelho Escuro</button>
                <button onclick="aplicarTema('laranja-claro')">Laranja Claro</button>
                <button onclick="aplicarTema('laranja-escuro')">Laranja Escuro</button>
                <button onclick="aplicarTema('amarelo-claro')">Amarelo Claro</button>
                <button onclick="aplicarTema('amarelo-escuro')">Amarelo Escuro</button>
                <button onclick="aplicarTema('verde-claro')">Verde Claro</button>
                <button onclick="aplicarTema('verde-escuro')">Verde Escuro</button>
                <button onclick="aplicarTema('azul-claro')">Azul Claro</button>
                <button onclick="aplicarTema('azul-escuro')">Azul Escuro</button>
                <button onclick="aplicarTema('anil-claro')">Anil Claro</button>
                <button onclick="aplicarTema('anil-escuro')">Anil Escuro</button>
                <button onclick="aplicarTema('violeta-claro')">Violeta Claro</button>
                <button onclick="aplicarTema('violeta-escuro')">Violeta Escuro</button>
                <button onclick="aplicarTema('pb-claro')">P&B Claro</button>
                <button onclick="aplicarTema('pb-escuro')">P&B Escuro</button>
            </div>
            <p style="margin-top: 20px; font-size: 0.9em; text-align: center;">O tema escolhido será salvo para sua próxima visita.</p>
        </div>
    </div>

    <div id="notificacoes-popup" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="fechar" onclick="fecharPopup('notificacoes-popup')">&times;</span>
            <h2><i class="fas fa-bell"></i> Suas Notificações</h2>
            
            <ul id="lista-notificacoes" style="list-style-type: none; padding: 0;">
            </ul>
            <button onclick="marcarNotificacoesComoLidas()" style="margin-top: 15px;"><i class="fas fa-check-double"></i> Marcar todas como lidas</button>
        </div>
    </div>

    <div id="perfil-pessoal-popup" class="modal">
        <div class="modal-content">
            <div class="modal-content-header">
                <span class="fechar" onclick="fecharPopup('perfil-pessoal-popup')">&times;</span>
                <h2><i class="fas fa-id-card"></i> Meu Perfil</h2>
                <span></span> </div>
            <div class="modal-content-body">
                <div id="dados-meu-perfil" style="text-align: center;">
                    <img id="minha-foto" src="" alt="Foto de Perfil" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--cor-principal);"><br>
                    <h3 id="meu-nome" style="margin: 10px 0;"></h3>
                    <p id="minha-descricao" style="max-width: 100%; word-wrap: break-word; font-style: italic;"></p>
                    <p>Avaliação Média: <span id="minha-media-estrelas" class="estrela"></span></p>
                </div>
                <button onclick="togglePopup('editar-perfil-popup', true)"><i class="fas fa-edit"></i> Editar Perfil</button>
                
                <h3 style="margin-top: 30px;">Minhas Histórias</h3>
                <div id="minhas-historias-container">
                </div>
            </div>
        </div>
    </div>
    
    <div id="perfil-publico-popup" class="modal">
        <div class="modal-content">
            <div class="modal-content-header">
                <span class="fechar" onclick="fecharPopup('perfil-publico-popup')">&times;</span>
                <h2><i class="fas fa-user-tag"></i> Perfil de <span id="publico-nome"></span></h2>
                <span></span>
            </div>
            <div class="modal-content-body">
                <div id="dados-perfil-publico" style="text-align: center;">
                    <img id="publico-foto" src="" alt="Foto de Perfil" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--cor-destaque);"><br>
                    <p id="publico-descricao" style="max-width: 100%; word-wrap: break-word; font-style: italic;"></p>
                    <p>Avaliação Média: <span id="publico-media-estrelas" class="estrela"></span></p>
                </div>
                <button onclick="abrirChatPrivado(usuarioPublicoAtualId)"><i class="fas fa-paper-plane"></i> Enviar Mensagem Privada</button>
                
                <h3 style="margin-top: 30px;">Histórias Postadas</h3>
                <div id="publico-historias-container">
                </div>
            </div>
        </div>
    </div>
    
    <div id="publicacoes-popup" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-content-header">
                <span class="fechar" onclick="fecharPopup('publicacoes-popup')">&times;</span>
                <h2><i class="fas fa-globe"></i> Coletânea Global de Histórias</h2>
                <span></span>
            </div>
            <div class="modal-content-body">
                <div id="lista-publicacoes">
                </div>
            </div>
        </div>
    </div>

    <div id="leitura-historia-popup" class="modal">
        <div class="modal-content" style="max-width: 900px; text-align: justify;">
            <div class="modal-content-header">
                <span class="fechar" onclick="fecharPopup('leitura-historia-popup')">&times;</span>
                <h2 id="titulo-livro">Título da História</h2>
                <span></span>
            </div>
            <div class="modal-content-body">
                <p style="text-align: center; font-style: italic;">Por: <a href="#" id="autor-livro">Nome do Autor</a></p>
                
                <div id="conteudo-livro" style="overflow-y: auto; padding: 10px; line-height: 1.6;">
                </div>
                
                <h3>Avaliação</h3>
                <div id="area-avaliacao">
                    <span class="estrela" data-nota="1" onclick="selecionarNota(1)">&#9733;</span>
                    <span class="estrela" data-nota="2" onclick="selecionarNota(2)">&#9733;</span>
                    <span class="estrela" data-nota="3" onclick="selecionarNota(3)">&#9733;</span>
                    <span class="estrela" data-nota="4" onclick="selecionarNota(4)">&#9733;</span>
                    <span class="estrela" data-nota="5" onclick="selecionarNota(5)">&#9733;</span>
                    <span id="nota-atual" style="margin-left: 10px;">(Clique nas estrelas)</span>
                    <button onclick="avaliarHistoria(historiaAtualId, window.notaSelecionada)" style="margin-left: 10px;">Avaliar</button>
                </div>

                <div id="acoes-historia" style="margin-top: 15px;">
                    <button onclick="curtirHistoria(historiaAtualId)"><i class="fas fa-heart"></i> Curtir (<span id="curtidas-count">0</span>)</button>
                    <button onclick="carregarComentarios(historiaAtualId); togglePopup('comentarios-popup');"><i class="fas fa-comment"></i> Comentários (<span id="comentarios-count">0</span>)</button>
                    <button onclick="compartilharHistoria(historiaAtualId)"><i class="fas fa-share-alt"></i> Compartilhar</button>
                    <button onclick="denunciarHistoria(historiaAtualId)" style="background-color: var(--cor-erro);"><i class="fas fa-flag"></i> Denunciar</button>
                </div>
                    
                <div id="botoes-autor" style="display:none; margin-top: 10px;">
                    <button onclick="editarHistoria(historiaAtualId)" style="background-color: #FFC300;"><i class="fas fa-edit"></i> Editar História</button>
                    <button onclick="apagarHistoria(historiaAtualId)" style="background-color: var(--cor-erro);"><i class="fas fa-trash-alt"></i> Apagar História</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="comentarios-popup" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-content-header">
                <span class="fechar" onclick="fecharPopup('comentarios-popup')">&times;</span>
                <h2><i class="fas fa-comments"></i> Comentários e Discussão</h2>
                <span></span>
            </div>
            <div class="modal-content-body">
                <div id="lista-comentarios" style="overflow-y: auto; padding: 10px; margin-bottom: 15px;">
                </div>
                
                <textarea id="novo-comentario-texto" placeholder="Deixe seu comentário..." style="resize: vertical;"></textarea>
                <button onclick="enviarComentario(historiaAtualId)"><i class="fas fa-paper-plane"></i> Comentar</button>
                <p id="comentario-resposta-info" style="font-size: 0.9em; color: gray;"></p>
            </div>
        </div>
    </div>

    <div id="chat-popup" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-content-header">
                <span class="fechar" onclick="fecharPopup('chat-popup')">&times;</span>
                <h2><i class="fas fa-comments"></i> Chat do Café</h2>
                <span></span>
            </div>
            <div class="modal-content-body">
                <div id="chat-tabs" style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                    <button id="tab-global" onclick="mudarChat('global')">Global</button>
                    <button id="tab-privado" onclick="mudarChat('privado')">Privado</button>
                </div>
                
                <div id="chat-global-area" class="chat-area">
                    <div id="mensagens-global" style="height: 300px; margin-bottom: 10px;">
                    </div>
                    <input type="text" id="mensagem-global-input" placeholder="Mensagem, link de imagem/vídeo..." style="width: 70%;">
                    <button onclick="enviarMensagem('global')"><i class="fas fa-paper-plane"></i> Enviar</button>
                </div>
                
                <div id="chat-privado-area" class="chat-area" style="display:none;">
                    <h3 id="conversa-ativa-titulo" style="margin-top: 10px;">Minhas Conversas</h3>
                    <div id="lista-conversas" style="overflow-y: auto; max-height: 150px; padding: 10px; margin-bottom: 10px; border: 1px solid var(--cor-destaque);">
                    </div>
                    
                    <div id="conversa-ativa-container" style="display:none;">
                        <div id="mensagens-privadas" style="height: 250px; margin-bottom: 10px;">
                        </div>
                        <input type="text" id="mensagem-privada-input" placeholder="Mensagem..." style="width: 70%;">
                        <button onclick="enviarMensagem('privado')"><i class="fas fa-paper-plane"></i> Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, update, onValue, push, query, orderByChild, limitToLast, remove, equalTo, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // Mantenha esta configuração com suas chaves reais do Firebase
          // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDlK9FaFDDCk2Est9B5rlGO7a4dWHBVm8M",
  authDomain: "fanfic-283fd.firebaseapp.com",
  databaseURL: "https://fanfic-283fd-default-rtdb.firebaseio.com",
  projectId: "fanfic-283fd",
  storageBucket: "fanfic-283fd.firebasestorage.app",
  messagingSenderId: "669849579403",
  appId: "1:669849579403:web:b697d7268cfc505b4dc98e",
  measurementId: "G-VXJLPP9HNH"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        window.usuarioAtual = null; 
        window.perfilLogado = null;
        window.historiaAtualId = null;
        window.usuarioPublicoAtualId = null;
        window.conversaAtivaId = null; 
        window.respostaComentarioId = null;
        window.notaSelecionada = 0; 

        window.togglePopup = (id, closeOthers = false) => {
            const popup = document.getElementById(id);
            if (!popup) return;
            
            // Se já estiver ativo, fecha
            if (popup.classList.contains('ativo')) { 
                popup.classList.remove('ativo');
                setTimeout(() => { popup.style.display = "none"; }, 300); // Esconde após a transição
                return;
            }
            
            // Abre o modal
            if (closeOthers) { 
                document.querySelectorAll('.modal.ativo').forEach(m => {
                     m.classList.remove('ativo');
                     // Para garantir que os popups tradicionais fechem imediatamente
                     if (m.id !== 'leitura-historia-popup' && m.id !== 'comentarios-popup' && m.id !== 'perfil-pessoal-popup' && m.id !== 'perfil-publico-popup' && m.id !== 'publicacoes-popup' && m.id !== 'chat-popup') {
                         m.style.display = 'none';
                     }
                }); 
            }
            
            popup.style.display = "block"; // Mostra para iniciar a transição
            // Adiciona a classe 'ativo' no próximo tick para forçar a transição
            setTimeout(() => { popup.classList.add('ativo'); }, 10);
        }
        
        window.fecharPopup = (id) => { 
            const popup = document.getElementById(id);
            if (popup) {
                popup.classList.remove('ativo');
                // Adiciona um pequeno atraso para fechar o display após a transição slide-out
                setTimeout(() => { 
                    popup.style.display = "none"; 
                }, 300); 
            }
        }
        
        window.onclick = function(event) {
            const modais = document.querySelectorAll('.modal');
            modais.forEach(modal => { 
                // Apenas fecha se clicar no backdrop E se o modal não for um dos que deslizam (para evitar o fechamento instantâneo)
                if (event.target == modal && !modal.querySelector('.modal-content-header')) { 
                    modal.classList.remove('ativo');
                    modal.style.display = "none"; 
                } 
            });
        }
        window.toggleSenha = (inputId, iconId) => {
             const input = document.getElementById(inputId);
             const icon = document.getElementById(iconId);
             if (input.type === 'password') {
                 input.type = 'text';
                 icon.classList.remove('fa-eye');
                 icon.classList.add('fa-eye-slash');
             } else {
                 input.type = 'password';
                 icon.classList.remove('fa-eye-slash');
                 icon.classList.add('fa-eye');
             }
        }
        function mostrarMensagem(idElemento, mensagem, sucesso = false) {
            const elem = document.getElementById(idElemento);
            elem.textContent = mensagem;
            elem.style.color = sucesso ? 'var(--cor-sucesso)' : 'var(--cor-erro)';
        }
        function gerarEstrelasHTML(media) {
            let html = '';
            const notaArredondada = Math.round(media);
            for (let i = 1; i <= 5; i++) {
                if (i <= notaArredondada) { html += '★'; } else { html += '☆'; }
            }
            return `<span class="estrela" style="color: gold;">${html} (${media.toFixed(1)})</span>`;
        }
        function formatarConteudo(texto) {
            // Suporte a múltiplas imagens e vídeos
            let html = texto.replace(/(http[s]?:\/\/[^\s]+\.(jpg|jpeg|png|gif))/g, '<img src="$1" style="max-width: 100%; height: auto; display: block; margin: 10px auto;" loading="lazy">');
            html = html.replace(/(http[s]?:\/\/(?:www\.)?youtube\.com\/watch\?v=([^\s]+))/g, '<iframe width="100%" height="315" src="https://www.youtube.com/embed/$2" frameborder="0" allowfullscreen style="margin: 10px 0;"></iframe>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        window.aplicarTema = (nomeTema) => {
             const body = document.body;
             body.className = ''; 
             if (nomeTema !== 'cafe-claro') { body.classList.add(nomeTema); }
             localStorage.setItem('temaFanficCafe', nomeTema);
        }
        const temaSalvo = localStorage.getItem('temaFanficCafe');
        if (temaSalvo) { window.aplicarTema(temaSalvo); } else { window.aplicarTema('cafe-claro'); }

        onAuthStateChanged(auth, (user) => {
            window.usuarioAtual = user;
            if (user) {
                document.getElementById('btn-meu-perfil').style.display = 'inline-block';
                document.getElementById('btn-chat').style.display = 'inline-block';
                document.getElementById('btn-criar-post').style.display = 'inline-block';
                document.getElementById('btn-logout').style.display = 'inline-block';
                document.getElementById('btn-login-cadastro').style.display = 'none';
                document.getElementById('notificacoes').style.display = 'flex'; 
                carregarDadosPerfil(user.uid);
                monitorarNotificacoes(user.uid); 
            } else {
                document.getElementById('btn-meu-perfil').style.display = 'none';
                document.getElementById('btn-chat').style.display = 'none';
                document.getElementById('btn-criar-post').style.display = 'none';
                document.getElementById('btn-logout').style.display = 'none';
                document.getElementById('btn-login-cadastro').style.display = 'inline-block';
                document.getElementById('notificacoes').style.display = 'none'; 
            }
        });

        window.fazerLogin = async () => {
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-senha').value;
            try {
                await signInWithEmailAndPassword(auth, email, senha);
                mostrarMensagem('auth-mensagem', 'Login bem-sucedido!', true);
                fecharPopup('login-cadastro-popup');
            } catch (error) {
                mostrarMensagem('auth-mensagem', `Erro no login: ${error.message.replace('Firebase: Error (auth/', '').replace(').', '')}`);
            }
        }
        window.fazerCadastro = async () => {
            const email = document.getElementById('cadastro-email').value;
            const senha = document.getElementById('cadastro-senha').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
                const userId = userCredential.user.uid;
                await set(ref(db, 'usuarios/' + userId), {
                    nome: email.split('@')[0],
                    fotoUrl: 'https://i.imgur.com/8Q9S8Qh.png', 
                    descricao: 'Novo membro do Fanfic Café!',
                    mediaAvaliacao: 0.0,
                    totalAvaliacoes: 0,
                    pontosPlacar: 10 
                });
                mostrarMensagem('auth-mensagem', 'Cadastro e login bem-sucedidos!', true);
                fecharPopup('login-cadastro-popup');
            } catch (error) {
                mostrarMensagem('auth-mensagem', `Erro no cadastro: ${error.message.replace('Firebase: Error (auth/', '').replace(').', '')}`);
            }
        }
        window.fazerLogout = async () => { 
            await signOut(auth); 
            window.perfilLogado = null;
            window.usuarioAtual = null;
        }
        window.carregarDadosPerfil = (uid) => {
            onValue(ref(db, 'usuarios/' + uid), (snapshot) => {
                const dados = snapshot.val();
                if (dados) {
                    window.perfilLogado = dados;
                    document.getElementById('meu-nome').textContent = dados.nome || 'Nome não definido';
                    document.getElementById('minha-foto').src = dados.fotoUrl || 'https://i.imgur.com/8Q9S8Qh.png';
                    document.getElementById('minha-descricao').textContent = dados.descricao || 'Ainda sem descrição...';
                    document.getElementById('minha-media-estrelas').innerHTML = gerarEstrelasHTML(dados.mediaAvaliacao || 0);
                    document.getElementById('edit-nome').value = dados.nome || '';
                    document.getElementById('edit-foto').value = dados.fotoUrl || '';
                    document.getElementById('edit-descricao').value = dados.descricao || '';
                    carregarHistoriasUsuario(uid, 'minhas-historias-container', true);
                }
            });
        }
        window.salvarEdicaoPerfil = async () => {
            if (!usuarioAtual) return;
            const novoNome = document.getElementById('edit-nome').value;
            const novaFoto = document.getElementById('edit-foto').value;
            const novaDescricao = document.getElementById('edit-descricao').value;
            try {
                 await update(ref(db, 'usuarios/' + usuarioAtual.uid), {
                    nome: novoNome,
                    fotoUrl: novaFoto,
                    descricao: novaDescricao.substring(0, 300)
                 });
                 alert('Perfil atualizado com sucesso!');
                 fecharPopup('editar-perfil-popup');
                 togglePopup('perfil-pessoal-popup');
            } catch (error) {
                alert('Erro ao salvar o perfil: ' + error.message);
            }
        }
        window.verPerfilPublico = async (uid) => {
            if (uid === usuarioAtual?.uid) { togglePopup('perfil-pessoal-popup', true); return; }
            usuarioPublicoAtualId = uid;
            const snapshot = await get(ref(db, 'usuarios/' + uid));
            const dados = snapshot.val();
            if (dados) {
                document.getElementById('publico-nome').textContent = dados.nome;
                document.getElementById('publico-foto').src = dados.fotoUrl || 'https://i.imgur.com/8Q9S8Qh.png';
                document.getElementById('publico-descricao').textContent = dados.descricao;
                document.getElementById('publico-media-estrelas').innerHTML = gerarEstrelasHTML(dados.mediaAvaliacao || 0);
                carregarHistoriasUsuario(uid, 'publico-historias-container', false);
                togglePopup('perfil-publico-popup', true);
            } else { alert('Perfil não encontrado.'); }
        }

        window.carregarPublicacoes = (containerId) => {
            const container = document.getElementById(containerId);
            container.innerHTML = 'Carregando histórias...';

            const publicacoesRef = ref(db, 'historias');
            onValue(publicacoesRef, (snapshot) => {
                container.innerHTML = '';
                const historias = [];
                snapshot.forEach(child => historias.push({ id: child.key, ...child.val() }));
                
                if (historias.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Nenhuma história publicada ainda. Seja o primeiro!</p>';
                    return;
                }

                historias.sort((a, b) => b.data - a.data); 

                historias.forEach(historia => {
                    const card = document.createElement('div');
                    card.className = 'historia-card';
                    card.onclick = () => verHistoria(historia.id);
                    
                    const media = historia.avaliacoes?.total > 0 ? historia.avaliacoes.soma / historia.avaliacoes.total : 0;

                    card.innerHTML = `
                        <img src="${historia.capaUrl || 'https://i.imgur.com/G5Y8u7H.png'}" alt="Capa">
                        <h4>${historia.titulo}</h4>
                        <p>Autor: ${historia.autorNome}</p>
                        <p>${gerarEstrelasHTML(media)}</p>
                        <small><i class="fas fa-heart"></i> ${historia.curtidas || 0}</small>
                    `;
                    container.appendChild(card);
                });
            });

            onValue(query(ref(db, 'historias'), orderByChild('curtidas'), limitToLast(4)), (snapshot) => {
                const destaquesContainer = document.getElementById('destaques-container');
                destaquesContainer.innerHTML = '';
                const destaques = [];
                snapshot.forEach(child => destaques.push({ id: child.key, ...child.val() }));
                destaques.reverse().forEach(historia => {
                    const card = document.createElement('div');
                    card.className = 'historia-card';
                    card.onclick = () => verHistoria(historia.id);
                    const media = historia.avaliacoes?.total > 0 ? historia.avaliacoes.soma / historia.avaliacoes.total : 0;
                    card.innerHTML = `
                        <img src="${historia.capaUrl || 'https://i.imgur.com/G5Y8u7H.png'}" alt="Capa">
                        <h4>${historia.titulo}</h4>
                        <p>${gerarEstrelasHTML(media)}</p>
                        <small>(${historia.curtidas || 0} Curtidas)</small>
                    `;
                    destaquesContainer.appendChild(card);
                });
            });
        }
        
        window.carregarHistoriasUsuario = (uid, containerId, isMyProfile) => {
            const container = document.getElementById(containerId);
            container.innerHTML = 'Buscando histórias...';

            onValue(query(ref(db, 'historias'), orderByChild('autorId'), equalTo(uid)), (snapshot) => {
                container.innerHTML = '';
                const historias = [];
                snapshot.forEach(child => historias.push({ id: child.key, ...child.val() }));
                
                if (historias.length === 0) {
                    container.innerHTML = `<p style="grid-column: 1 / -1; text-align: center;">${isMyProfile ? 'Você não' : 'Este usuário não'} publicou histórias ainda.</p>`;
                    return;
                }

                historias.forEach(historia => {
                    const card = document.createElement('div');
                    card.className = 'historia-card';
                    card.onclick = () => verHistoria(historia.id);
                    
                    const media = historia.avaliacoes?.total > 0 ? historia.avaliacoes.soma / historia.avaliacoes.total : 0;

                    card.innerHTML = `
                        <img src="${historia.capaUrl || 'https://i.imgur.com/G5Y8u7H.png'}" alt="Capa">
                        <h4>${historia.titulo}</h4>
                        <p>${gerarEstrelasHTML(media)}</p>
                    `;
                    container.appendChild(card);
                });
            });
        }
        
        window.verHistoria = async (id) => {
            historiaAtualId = id;
            const snapshot = await get(ref(db, `historias/${id}`));
            const historia = snapshot.val();
            if (!historia) return;
            
            // Título e Autor para o novo Header
            document.getElementById('titulo-livro').textContent = historia.titulo;
            document.getElementById('autor-livro').textContent = historia.autorNome;
            document.getElementById('autor-livro').onclick = () => verPerfilPublico(historia.autorId);
            document.getElementById('conteudo-livro').innerHTML = formatarConteudo(historia.conteudo);
            document.getElementById('curtidas-count').textContent = historia.curtidas || 0;
            
            const notaUsuario = historia.avaliadores?.[usuarioAtual?.uid] || 0;
            selecionarNota(notaUsuario); 

            // NOVO: Garantir que os botões de autor apareçam lado a lado (flex)
            const botoesAutor = document.getElementById('botoes-autor');
            if (usuarioAtual && historia.autorId === usuarioAtual.uid) {
                botoesAutor.style.display = 'flex'; 
            } else {
                botoesAutor.style.display = 'none';
            }

            togglePopup('leitura-historia-popup', true);
            carregarComentarios(id); 
        }
        
        window.publicarHistoria = async () => {
            if (!usuarioAtual || !perfilLogado) { alert('Faça login para publicar!'); return; }
            const titulo = document.getElementById('post-titulo').value;
            const capa = document.getElementById('post-capa').value;
            const conteudo = document.getElementById('post-conteudo').value;
            if (!titulo || !conteudo || !capa) { alert('Preencha todos os campos!'); return; }
            try {
                const novaHistoriaRef = push(ref(db, 'historias'));
                await set(novaHistoriaRef, {
                    titulo, capaUrl: capa, conteudo, autorId: usuarioAtual.uid, autorNome: perfilLogado.nome,
                    data: Date.now(), curtidas: 0, 
                    avaliacoes: { total: 0, soma: 0 }, 
                    denuncias: 0,
                    avaliadores: {} 
                });
                alert('História publicada com sucesso! Lembre-se que você não pode avaliar a sua própria história.');
                fecharPopup('criar-post-popup');
                document.getElementById('post-titulo').value = '';
                document.getElementById('post-capa').value = '';
                document.getElementById('post-conteudo').value = '';
            } catch (error) { alert('Erro ao publicar: ' + error.message); }
        }
        
        window.curtirHistoria = async (id) => {
            if (!usuarioAtual) { alert('Faça login para curtir!'); return; }
            const historiaRef = ref(db, `historias/${id}`);
            const curtidasRef = ref(db, `historias/${id}/curtidas`);
            
            await runTransaction(historiaRef, (historia) => {
                if (historia) {
                    if (!historia.curtiu) { historia.curtiu = {}; }
                    if (!historia.curtidas) { historia.curtidas = 0; }

                    if (historia.curtiu[usuarioAtual.uid]) {
                        historia.curtidas--;
                        historia.curtiu[usuarioAtual.uid] = null; 
                    } else {
                        historia.curtidas++;
                        historia.curtiu[usuarioAtual.uid] = true; 
                        if(historia.autorId !== usuarioAtual.uid) {
                            enviarNotificacao(historia.autorId, `sua história "${historia.titulo}" recebeu uma curtida de ${perfilLogado.nome}.`);
                        }
                    }
                }
                return historia;
            });
            
            const snapshot = await get(curtidasRef);
            document.getElementById('curtidas-count').textContent = snapshot.val() || 0;
        }

        window.avaliarHistoria = async (historiaId, novaNota) => {
            if (!usuarioAtual) { alert('Faça login para avaliar!'); return; }
            if (novaNota === 0) { alert('Selecione uma nota de 1 a 5.'); return; }

            const historiaRef = ref(db, `historias/${historiaId}`);
            const autorId = (await get(historiaRef)).val().autorId;

            if (autorId === usuarioAtual.uid) { alert('Você não pode avaliar sua própria história!'); return; }

            try {
                const result = await runTransaction(historiaRef, (historia) => {
                    if (historia) {
                        if (!historia.avaliacoes) { historia.avaliacoes = { total: 0, soma: 0 }; }
                        if (!historia.avaliadores) { historia.avaliadores = {}; }

                        const notaAnterior = historia.avaliadores[usuarioAtual.uid] || 0;

                        if (notaAnterior > 0) {
                            historia.avaliacoes.soma -= notaAnterior;
                            historia.avaliacoes.soma += novaNota;
                            historia.avaliadores[usuarioAtual.uid] = novaNota;
                        } else {
                            historia.avaliacoes.total++;
                            historia.avaliacoes.soma += novaNota;
                            historia.avaliadores[usuarioAtual.uid] = novaNota;
                        }

                        historia.mediaAtual = historia.avaliacoes.total > 0 ? historia.avaliacoes.soma / historia.avaliacoes.total : 0;
                    }
                    return historia;
                });

                if (result.committed) {
                    const mediaAtualizada = result.snapshot.val().mediaAtual;
                    await runTransaction(ref(db, `usuarios/${autorId}`), (autor) => {
                        if (autor) {
                            autor.pontosPlacar = (autor.pontosPlacar || 0) + (novaNota * 2); 
                            autor.mediaAvaliacao = mediaAtualizada; 
                        }
                        return autor;
                    });

                    selecionarNota(novaNota);
                    alert(`Obrigado por avaliar! Nota: ${novaNota}.`);
                    enviarNotificacao(autorId, `sua história "${result.snapshot.val().titulo}" foi avaliada com nota ${novaNota}.`);
                }
            } catch (error) {
                console.error("Erro na transação de avaliação:", error);
                alert("Ocorreu um erro ao avaliar a história.");
            }
        }

        window.compartilharHistoria = async (id) => {
            const historiaSnapshot = await get(ref(db, `historias/${id}`));
            const historia = historiaSnapshot.val();
            if (!historia) return;
            
            const shareData = {
                title: `Fanfic Café: Leia ${historia.titulo}`,
                text: `Acabei de ler "${historia.titulo}" de ${historia.autorNome} no Fanfic Café! Venha ler e avaliar.`,
                url: window.location.href 
            };
            
            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    alert(`Erro ao compartilhar: ${err}. Copie o link: ${window.location.href}`);
                }
            } else {
                alert(`Compartilhado! (Funcionalidade de API de Compartilhamento Nativo não suportada no seu navegador. Copie o link: ${window.location.href})`);
            }
        }


        window.denunciarHistoria = async (id) => {
            if (!usuarioAtual) { alert('Faça login para denunciar!'); return; }
            const historiaRef = ref(db, `historias/${id}`);
            
            try {
                await runTransaction(historiaRef, (historia) => {
                    if (historia) {
                        if (!historia.denuncias) { historia.denuncias = 0; }
                        historia.denuncias++;
                    }
                    return historia;
                });
                alert('Denúncia enviada. Nossa equipe irá analisar esta história.');
            } catch (error) {
                alert('Erro ao denunciar.');
            }
        }
        
        window.editarHistoria = async (id) => { 
            // A função é ligada ao botão.
            alert("Funcionalidade de Edição de História: Implementação da interface completa (WYSIWYG) pendente. Por enquanto, utilize a função Apagar e republique, se necessário."); 
        }
        
        window.apagarHistoria = async (id) => {
            if (!usuarioAtual) return;
            const historiaSnapshot = await get(ref(db, `historias/${id}`));
            const historia = historiaSnapshot.val();

            if (historia.autorId !== usuarioAtual.uid) { alert('Você só pode apagar suas próprias histórias.'); return; }
            if (!confirm(`Tem certeza que deseja apagar a história: "${historia.titulo}"? Esta ação é irreversível.`)) return;

            try {
                await remove(ref(db, `historias/${id}`));
                alert('História apagada com sucesso.');
                fecharPopup('leitura-historia-popup');
                // Recarregar a lista de histórias do autor para refletir a exclusão
                carregarHistoriasUsuario(usuarioAtual.uid, 'minhas-historias-container', true);
            } catch (error) {
                alert('Erro ao apagar a história: ' + error.message);
            }
        }
        
        window.selecionarNota = (nota) => {
            window.notaSelecionada = nota;
            const estrelas = document.querySelectorAll('#area-avaliacao .estrela');
            estrelas.forEach((star, index) => {
                star.style.color = index < nota ? 'gold' : 'gray';
            });
            document.getElementById('nota-atual').textContent = `(${nota}/5) - Clique em Avaliar`;
        }
        
        window.carregarComentarios = (historiaId) => {
            const comentariosRef = ref(db, `historias/${historiaId}/comentarios`);
            onValue(comentariosRef, (snapshot) => {
                const container = document.getElementById('lista-comentarios');
                container.innerHTML = '<h4>Discussão:</h4>';
                
                let count = 0;
                const comentariosData = [];
                snapshot.forEach(child => comentariosData.push({ id: child.key, ...child.val() }));
                
                comentariosData.reverse().forEach(comentario => {
                    count++;
                    const id = comentario.id;

                    const divComentario = document.createElement('div');
                    divComentario.style.borderLeft = '3px solid var(--cor-destaque)';
                    divComentario.style.padding = '5px 10px';
                    divComentario.style.marginBottom = '10px';

                    let html = `
                        <p style="margin: 0; font-weight: bold;">${comentario.autorNome}:</p>
                        <p style="margin: 5px 0 0 0;">${comentario.texto}</p>
                        <small style="color: gray; display: flex; justify-content: space-between; align-items: center;">
                            ${new Date(comentario.data).toLocaleDateString()}
                            <button class="btn" onclick="prepararResposta('${id}', '${comentario.autorNome}')" style="padding: 5px 10px; font-size: 0.8em; margin: 0;">Responder</button>
                        </small>
                        <div id="respostas-${id}" style="margin-left: 20px;"></div>
                    `;
                    divComentario.innerHTML = html;
                    container.appendChild(divComentario);
                    
                    const respostasContainer = document.getElementById(`respostas-${id}`);
                    if (comentario.respostas) {
                        Object.values(comentario.respostas).forEach(resposta => {
                            const pResposta = document.createElement('p');
                            pResposta.style.cssText = 'border-left: 2px dotted gray; padding-left: 5px; margin: 5px 0; font-size: 0.9em;';
                            pResposta.innerHTML = `<em>${resposta.autorNome} em resposta:</em> ${resposta.texto}`;
                            respostasContainer.appendChild(pResposta);
                            count++; 
                        });
                    }
                });
                document.getElementById('comentarios-count').textContent = count;
                document.getElementById('comentario-resposta-info').textContent = '';
                window.respostaComentarioId = null;
            });
        }
        window.prepararResposta = (comentarioId, autorNome) => {
             window.respostaComentarioId = comentarioId;
             document.getElementById('comentario-resposta-info').textContent = `Você está respondendo a: ${autorNome}. Clique em Comentar novamente para enviar.`;
        }
        window.enviarComentario = async (historiaId) => {
            if (!usuarioAtual) { alert('Faça login para comentar!'); return; }
            const texto = document.getElementById('novo-comentario-texto').value;
            if (!texto) return;

            const novoComentario = {
                autorId: usuarioAtual.uid,
                autorNome: perfilLogado?.nome || 'Anônimo',
                texto: texto,
                data: Date.now()
            };

            try {
                if (window.respostaComentarioId) {
                    const respostaRef = ref(db, `historias/${historiaId}/comentarios/${window.respostaComentarioId}/respostas`);
                    await push(respostaRef, novoComentario);

                    const comentarioOriginal = await get(ref(db, `historias/${historiaId}/comentarios/${window.respostaComentarioId}`));
                    if (comentarioOriginal.val()?.autorId !== usuarioAtual.uid) {
                         enviarNotificacao(comentarioOriginal.val().autorId, `você recebeu uma resposta em seu comentário na história.`);
                    }

                } else {
                    const comentariosRef = ref(db, `historias/${historiaId}/comentarios`);
                    await push(comentariosRef, novoComentario);
                    
                    const historia = await get(ref(db, `historias/${historiaId}`));
                    if (historia.val()?.autorId !== usuarioAtual.uid) {
                         enviarNotificacao(historia.val().autorId, `sua história "${historia.val().titulo}" recebeu um novo comentário.`);
                    }
                }
                document.getElementById('novo-comentario-texto').value = '';
                window.respostaComentarioId = null;
                document.getElementById('comentario-resposta-info').textContent = '';
            } catch (error) {
                alert('Erro ao enviar comentário: ' + error.message);
            }
        }

        window.mudarChat = (tipo) => {
            if (!usuarioAtual) { alert('Faça login para usar o chat!'); return; }
            document.getElementById('chat-global-area').style.display = tipo === 'global' ? 'block' : 'none';
            document.getElementById('chat-privado-area').style.display = tipo === 'privado' ? 'block' : 'none';
            document.getElementById('tab-global').style.backgroundColor = tipo === 'global' ? 'var(--cor-principal)' : 'var(--cor-destaque)';
            document.getElementById('tab-privado').style.backgroundColor = tipo === 'privado' ? 'var(--cor-principal)' : 'var(--cor-destaque)';
            
            if (tipo === 'global') { carregarMensagensGlobal(); } 
            else { carregarConversasPrivadas(); document.getElementById('conversa-ativa-container').style.display = 'none'; }
        }
        
        window.carregarMensagensGlobal = () => {
             const mensagensRef = ref(db, 'chat/global');
             onValue(query(mensagensRef, limitToLast(20)), (snapshot) => {
                 const container = document.getElementById('mensagens-global');
                 container.innerHTML = '';
                 snapshot.forEach(child => {
                     const msg = child.val();
                     const p = document.createElement('p');
                     p.innerHTML = `<strong>${msg.autorNome}:</strong> ${formatarConteudo(msg.texto)}`;
                     container.appendChild(p);
                 });
                 container.scrollTop = container.scrollHeight;
             });
        }
        
        window.carregarConversasPrivadas = () => {
             const listaConversas = document.getElementById('lista-conversas');
             listaConversas.innerHTML = '';

             onValue(ref(db, 'usuarios'), (snapshot) => {
                 listaConversas.innerHTML = '';
                 snapshot.forEach(child => {
                     const user = child.val();
                     const userId = child.key;
                     if (usuarioAtual && userId !== usuarioAtual.uid) {
                         const li = document.createElement('li');
                         li.style.padding = '5px 0';
                         li.innerHTML = `<a href="#" onclick="abrirChatPrivado('${userId}')" style="color: var(--cor-principal); text-decoration: none;">Chat com <strong>${user.nome}</strong></a>`;
                         listaConversas.appendChild(li);
                     }
                 });
                 if (listaConversas.children.length === 0) {
                      listaConversas.innerHTML = '<p>Nenhuma conversa. Inicie uma clicando em um perfil público.</p>';
                 }
             });
        }
        
        window.abrirChatPrivado = async (targetUserId) => {
             if (!usuarioAtual) return;
             
             const userA = usuarioAtual.uid;
             const userB = targetUserId;
             window.conversaAtivaId = userA < userB ? `${userA}-${userB}` : `${userB}-${userA}`;
             
             const targetUserSnapshot = await get(ref(db, `usuarios/${targetUserId}`));
             const targetUser = targetUserSnapshot.val();

             document.getElementById('conversa-ativa-titulo').textContent = `Chat com ${targetUser.nome}`;
             document.getElementById('conversa-ativa-container').style.display = 'block';
             
             const mensagensRef = ref(db, `chat/privado/${window.conversaAtivaId}`);
             onValue(query(mensagensRef, limitToLast(30)), (snapshot) => {
                 const container = document.getElementById('mensagens-privadas');
                 container.innerHTML = '';
                 snapshot.forEach(child => {
                     const msg = child.val();
                     const isMyMsg = msg.autorId === usuarioAtual.uid;
                     const p = document.createElement('p');
                     p.style.cssText = `text-align: ${isMyMsg ? 'right' : 'left'}; margin: 5px 0;`;
                     p.innerHTML = `<span style="font-weight: bold; color: ${isMyMsg ? 'var(--cor-sucesso)' : 'var(--cor-principal)'};">${msg.autorNome}:</span> ${msg.texto}`;
                     container.appendChild(p);
                 });
                 container.scrollTop = container.scrollHeight;
             });

             fecharPopup('perfil-publico-popup');
             togglePopup('chat-popup');
             mudarChat('privado');
        }

        window.enviarMensagem = async (tipo) => {
             if (!usuarioAtual) return;
             const inputId = tipo === 'global' ? 'mensagem-global-input' : 'mensagem-privada-input';
             const texto = document.getElementById(inputId).value;
             if (!texto) return;
             
             const novaMensagem = { autorId: usuarioAtual.uid, autorNome: perfilLogado?.nome || 'Anônimo', texto: texto, data: Date.now() };

             try {
                 if (tipo === 'global') {
                    await push(ref(db, 'chat/global'), novaMensagem);
                    document.getElementById(inputId).value = '';
                 } else if (window.conversaAtivaId) {
                    await push(ref(db, `chat/privado/${window.conversaAtivaId}`), novaMensagem);
                    document.getElementById(inputId).value = '';
                    
                    const [id1, id2] = window.conversaAtivaId.split('-');
                    const outroUserId = id1 === usuarioAtual.uid ? id2 : id1;
                    enviarNotificacao(outroUserId, `você recebeu uma nova mensagem privada de ${perfilLogado.nome}.`);
                 } else {
                     alert("Selecione uma conversa ou inicie uma via Perfil Público.");
                 }
             } catch (error) { alert('Erro ao enviar mensagem: ' + error.message); }
        }

        window.monitorarNotificacoes = (uid) => {
            const notifRef = ref(db, 'notificacoes/' + uid);
            // Corrigido para monitorar apenas as notificações não lidas
            onValue(query(notifRef, orderByChild('lida'), equalTo(false)), (snapshot) => {
                const contador = snapshot.size;
                document.getElementById('contador-notificacoes').textContent = contador;
                document.getElementById('notificacoes').style.display = 'flex'; 
            });
        }
        
        window.carregarNotificacoes = () => {
             if (!usuarioAtual) return;
             const lista = document.getElementById('lista-notificacoes');
             lista.innerHTML = 'Carregando...';
             
             onValue(query(ref(db, `notificacoes/${usuarioAtual.uid}`), orderByChild('data'), limitToLast(20)), (snapshot) => {
                 lista.innerHTML = '';
                 const notificacoes = [];
                 snapshot.forEach(child => {
                     notificacoes.push({ id: child.key, ...child.val() });
                 });
                 
                 notificacoes.reverse().forEach(notif => {
                     const li = document.createElement('li');
                     li.className = notif.lida ? 'notificacao-lida' : 'notificacao-nao-lida';
                     li.innerHTML = `<i class="fas fa-info-circle"></i> ${notif.mensagem} <small>(${new Date(notif.data).toLocaleTimeString()})</small>`;
                     li.onclick = async () => {
                         await update(ref(db, `notificacoes/${usuarioAtual.uid}/${notif.id}`), { lida: true });
                     };
                     lista.appendChild(li);
                 });
                 if (lista.children.length === 0) { lista.innerHTML = '<li>Nenhuma notificação.</li>'; }
             });
        }
        
        window.marcarNotificacoesComoLidas = async () => {
            if (!usuarioAtual) return;
            const notifRef = ref(db, `notificacoes/${usuarioAtual.uid}`);
            
            const snapshot = await get(query(notifRef, orderByChild('lida'), equalTo(false)));
            const updates = {};
            snapshot.forEach(child => {
                updates[`${child.key}/lida`] = true;
            });

            if (Object.keys(updates).length > 0) {
                await update(notifRef, updates);
                alert("Todas as notificações foram marcadas como lidas.");
            } else {
                 alert("Nenhuma notificação pendente.");
            }
        }
        
        window.enviarNotificacao = async (targetUserId, mensagem) => {
            if (usuarioAtual && targetUserId === usuarioAtual.uid) return;
            await push(ref(db, `notificacoes/${targetUserId}`), {
                remetenteId: usuarioAtual?.uid || 'Sistema',
                mensagem: mensagem,
                lida: false,
                data: Date.now()
            });
        }

        window.carregarPlacar = () => {
             const placarRef = query(ref(db, 'usuarios'), orderByChild('pontosPlacar'), limitToLast(10));
             onValue(placarRef, (snapshot) => {
                 const lista = document.getElementById('lista-placar');
                 lista.innerHTML = '';
                 let usuarios = [];
                 snapshot.forEach(child => usuarios.push({ uid: child.key, ...child.val() }));
                 usuarios.sort((a, b) => (b.pontosPlacar || 0) - (a.pontosPlacar || 0)); 

                 if (usuarios.length === 0) { lista.innerHTML = '<li>Nenhum usuário no placar ainda.</li>'; return; }
                 
                 usuarios.forEach((user, index) => {
                     const li = document.createElement('li');
                     const icone = index === 0 ? '<i class="fas fa-crown" style="color: gold;"></i>' : 
                                   index === 1 ? '<i class="fas fa-award" style="color: silver;"></i>' : 
                                   index === 2 ? '<i class="fas fa-award" style="color: bronze;"></i>' : '';
                     
                     li.innerHTML = `${icone} <span onclick="verPerfilPublico('${user.uid}')" style="cursor:pointer; font-weight:bold;">${user.nome}</span> (${user.pontosPlacar || 0} pts - ${user.mediaAvaliacao?.toFixed(1) || 0.0} ${gerarEstrelasHTML(user.mediaAvaliacao || 0)})`;
                     lista.appendChild(li);
                 });
             });
        }

        window.onload = () => {
             carregarPublicacoes('lista-publicacoes'); 
             document.querySelector('button[onclick="togglePopup(\'placar-popup\', true)"]').addEventListener('click', carregarPlacar);
        }

    </script>
    
</body>
</html>
