<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fanfic Café</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Cores Modernas - Palette "Coffee House" */
            --primary: #6F4E37;
            --primary-dark: #4A332A;
            --accent: #D4A373;
            --bg-body: #FAF9F6;
            --bg-card: #FFFFFF;
            --text-main: #2C2C2C;
            --text-muted: #666666;
            --success: #2E7D32;
            --error: #D32F2F;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.12);
            --radius: 12px;
            
            --font-ui: 'Poppins', sans-serif;
            --font-read: 'Merriweather', serif;
        }

        /* Temas Dinâmicos */
        body.dark-mode { --primary: #D4A373; --primary-dark: #A97C50; --accent: #6F4E37; --bg-body: #121212; --bg-card: #1E1E1E; --text-main: #E0E0E0; --text-muted: #AAAAAA; }
        
        * { box-sizing: border-box; outline: none; }

        body { 
            font-family: var(--font-ui);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        body.modal-open { overflow: hidden; } /* Previne scroll no fundo */

        /* --- Header Moderno --- */
        header { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
        }
        body.dark-mode header { background: rgba(30, 30, 30, 0.9); border-bottom: 1px solid rgba(255,255,255,0.05); }

        .logo-area h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 700; letter-spacing: -0.5px; }
        .logo-area span { font-size: 0.8rem; color: var(--text-muted); font-weight: 300; }

        /* --- Notificações (Sino) --- */
        #notificacoes-btn { 
            position: relative; cursor: pointer; color: var(--text-main); font-size: 1.2rem; padding: 8px; transition: 0.2s;
        }
        #notificacoes-btn:hover { color: var(--primary); transform: scale(1.1); }
        #contador-notificacoes {
            position: absolute; top: 0; right: 0; background: var(--error); color: white;
            font-size: 0.6rem; padding: 2px 5px; border-radius: 10px; font-weight: bold;
        }

        /* --- Main Content --- */
        main { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; flex: 1; }

        h2 { border-left: 4px solid var(--primary); padding-left: 15px; margin-top: 40px; margin-bottom: 20px; color: var(--text-main); }

        /* --- Buttons --- */
        .btn, button { 
            background-color: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 50px; cursor: pointer; font-family: var(--font-ui); font-weight: 600;
            font-size: 0.9rem; transition: all 0.2s ease; box-shadow: var(--shadow-sm);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover, button:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-secondary { background-color: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-secondary:hover { background-color: var(--primary); color: white; }
        .btn-danger { background-color: var(--error); }
        .btn-danger:hover { background-color: #B71C1C; }
        
        /* --- Grid de Ações Rápidas --- */
        #botoes-acesso { 
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; 
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        #botoes-acesso::-webkit-scrollbar { display: none; }
        #botoes-acesso button { flex-shrink: 0; white-space: nowrap; }

        /* --- Cards de Histórias --- */
        .grid-container { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; 
        }
        .historia-card { 
            background: var(--bg-card); border-radius: var(--radius); overflow: hidden;
            box-shadow: var(--shadow-sm); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer;
            display: flex; flex-direction: column;
        }
        .historia-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .historia-card img { 
            width: 100%; height: 160px; object-fit: cover; 
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .card-content h4 { margin: 0 0 5px; font-size: 1.1rem; color: var(--text-main); line-height: 1.3; }
        .card-content p { font-size: 0.85rem; color: var(--text-muted); margin: 0 0 10px; }
        .card-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-muted); }
        .estrela { color: #FFC107; }

        /* --- Forms & Inputs --- */
        input, textarea, select { 
            width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 8px; font-family: var(--font-ui); background: var(--bg-card); color: var(--text-main);
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(111, 78, 55, 0.1); }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input { margin-bottom: 0; }
        .toggle-senha { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted); }

        /* --- Sistema de Modais (Popups) --- */
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s;
        }
        .modal.ativo { display: flex; opacity: 1; align-items: center; justify-content: center; }
        
        /* Modal Padrão (Pequeno/Médio) */
        .modal-content { 
            background: var(--bg-card); width: 90%; max-width: 500px; max-height: 90vh;
            border-radius: var(--radius); box-shadow: var(--shadow-md); position: relative;
            display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: transform 0.3s;
        }
        .modal.ativo .modal-content { transform: scale(1); }

        /* Modal Tela Cheia (Leitura/Chat) */
        .modal-fullscreen .modal-content { 
            width: 100%; height: 100%; max-width: none; max-height: none; border-radius: 0; 
        }

        .modal-header { 
            padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.1); display: flex; 
            justify-content: space-between; align-items: center; background: var(--bg-card); z-index: 2;
        }
        .modal-header h2 { margin: 0; font-size: 1.2rem; border: none; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .close-btn { background: none; color: var(--text-muted); font-size: 1.5rem; padding: 0; width: auto; box-shadow: none; }
        .close-btn:hover { background: none; color: var(--error); transform: none; }

        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }

        /* --- Leitura Específica --- */
        #conteudo-livro { 
            font-family: var(--font-read); font-size: 1.15rem; line-height: 1.8; color: var(--text-main); 
            white-space: pre-wrap; margin-bottom: 30px; 
        }
        #conteudo-livro img { max-width: 100%; height: auto; border-radius: 8px; margin: 15px auto; display: block; }

        /* --- Chat --- */
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.02); }
        .msg-bubble { 
            max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; position: relative; word-wrap: break-word;
        }
        .msg-left { background: #e5e5ea; color: black; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-right { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        body.dark-mode .msg-left { background: #333; color: white; }
        .chat-input-area { padding: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 10px; }

        /* --- Toast Notifications --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            background: #333; color: white; padding: 12px 20px; border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 0.9rem; animation: slideIn 0.3s ease;
            display: flex; align-items: center; gap: 10px; min-width: 250px;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--error); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- Loader --- */
        .loader {
            border: 3px solid rgba(0,0,0,0.1); border-top: 3px solid var(--primary);
            border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Fixes */
        @media (max-width: 768px) {
            .modal-content { width: 100%; height: 100%; max-width: none; border-radius: 0; }
            header { padding: 10px 15px; }
            .grid-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            <h1><i class="fas fa-mug-hot"></i> Fanfic Café</h1>
            <span>Histórias quentinhas para você</span>
        </div>
        <div id="notificacoes-btn" onclick="app.abrirNotificacoes()">
            <i class="fas fa-bell"></i> <span id="contador-notificacoes" style="display:none">0</span>
        </div>
    </header>

    <div id="toast-container"></div>

    <main id="app-main">
        <div id="botoes-acesso">
            </div>

        <h2 id="titulo-secao">Destaques da Semana</h2>
        <div id="destaques-container" class="grid-container">
            <div class="loader"></div>
        </div>

        <h2>Todas as Histórias</h2>
        <div id="lista-publicacoes" class="grid-container">
            <div class="loader"></div>
        </div>
    </main>

    <div id="modal-auth" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Acesso</h2>
                <button class="close-btn" onclick="app.fecharModal('modal-auth')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn" id="tab-login" onclick="app.toggleAuthTab('login')" style="width:45%">Login</button>
                    <button class="btn btn-secondary" id="tab-cadastro" onclick="app.toggleAuthTab('cadastro')" style="width:45%">Cadastro</button>
                </div>
                
                <form id="form-auth" onsubmit="event.preventDefault();">
                    <input type="email" id="auth-email" placeholder="Seu E-mail" required>
                    <div class="input-group">
                        <input type="password" id="auth-senha" placeholder="Sua Senha" required>
                        <span class="toggle-senha" onclick="app.toggleSenha('auth-senha')"><i class="fas fa-eye"></i></span>
                    </div>
                    <button id="btn-submit-auth" onclick="app.processarAuth()" style="width: 100%">Entrar</button>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-criar" class="modal modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-pen-nib"></i> Nova História</h2>
                <button class="close-btn" onclick="app.fecharModal('modal-criar')">&times;</button>
            </div>
            <div class="modal-body">
                <label>Título</label>
                <input type="text" id="post-titulo" placeholder="O título da sua obra">
                <label>Capa (URL da Imagem)</label>
                <input type="url" id="post-capa" placeholder="https://...">
                <label>Conteúdo (Aceita HTML básico e links de imagem/YouTube)</label>
                <textarea id="post-conteudo" style="height: 60vh; resize: none;" placeholder="Era uma vez..."></textarea>
                <button onclick="app.publicarHistoria()" style="width: 100%; margin-top: 10px;"><i class="fas fa-paper-plane"></i> Publicar Obra</button>
            </div>
        </div>
    </div>

    <div id="modal-leitura" class="modal modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="leitura-titulo" style="font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80%;">Carregando...</h2>
                <button class="close-btn" onclick="app.fecharModal('modal-leitura')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 20px; color: var(--text-muted);">
                        <span id="leitura-autor" style="cursor: pointer; text-decoration: underline;">Autor</span> &bull; 
                        <span id="leitura-data">Data</span>
                    </div>
                    <div id="conteudo-livro"></div>
                    
                    <hr style="border: 0; border-top: 1px solid #ddd; margin: 40px 0;">
                    
                    <h3>Avaliar essa obra</h3>
                    <div id="area-avaliacao" style="font-size: 2rem; cursor: pointer; margin-bottom: 20px;">
                        </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn-secondary" onclick="app.curtirHistoria()"><i class="fas fa-heart"></i> <span id="leitura-curtidas">0</span></button>
                        <button class="btn-secondary" onclick="app.abrirComentarios()"><i class="fas fa-comment"></i> Comentários</button>
                        <button class="btn-secondary" onclick="app.compartilhar()"><i class="fas fa-share-alt"></i></button>
                    </div>
                    
                    <div id="admin-buttons" style="margin-top: 20px; display: none; justify-content: center;">
                        <button class="btn-danger" onclick="app.apagarHistoria()"><i class="fas fa-trash"></i> Excluir História</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-comentarios" class="modal">
        <div class="modal-content" style="height: 80vh;">
            <div class="modal-header">
                <h2>Comentários</h2>
                <button class="close-btn" onclick="app.fecharModal('modal-comentarios')">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column;">
                <div id="lista-comentarios" style="flex: 1; overflow-y: auto; margin-bottom: 15px;"></div>
                <div class="chat-input-area">
                    <input type="text" id="input-comentario" placeholder="Escreva algo gentil..." style="margin: 0;">
                    <button onclick="app.enviarComentario()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-perfil" class="modal modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Perfil</h2>
                <button class="close-btn" onclick="app.fecharModal('modal-perfil')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; max-width: 600px; margin: 0 auto;">
                    <img id="perfil-foto" src="" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); margin-bottom: 15px;">
                    <h2 id="perfil-nome" style="border: none; margin: 0; justify-content: center;">Nome</h2>
                    <p id="perfil-bio" style="font-style: italic; color: var(--text-muted);"></p>
                    <div style="margin: 20px 0;">
                        <span id="perfil-stats"></span>
                    </div>
                    
                    <div id="perfil-actions" style="margin-bottom: 30px;">
                        </div>

                    <h3 style="text-align: left; border-left: 4px solid var(--accent); padding-left: 10px;">Histórias Publicadas</h3>
                    <div id="perfil-historias" class="grid-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-editar-perfil" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Perfil</h2>
                <button class="close-btn" onclick="app.fecharModal('modal-editar-perfil')">&times;</button>
            </div>
            <div class="modal-body">
                <label>Nome</label>
                <input type="text" id="edit-nome">
                <label>Link da Foto (URL)</label>
                <input type="url" id="edit-foto">
                <label>Sobre Você</label>
                <textarea id="edit-bio" rows="4"></textarea>
                <button onclick="app.salvarPerfil()" style="width: 100%">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div id="modal-chat" class="modal modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="chat-titulo"><i class="fas fa-comments"></i> Chat Global</h2>
                <div>
                    <button class="btn-secondary" onclick="app.alternarChatMode()" style="font-size: 0.8rem; padding: 5px 10px; margin-right: 10px;">
                        <i class="fas fa-exchange-alt"></i> Trocar
                    </button>
                    <button class="close-btn" onclick="app.fecharModal('modal-chat')">&times;</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div id="chat-lista-conversas" style="display: none; padding: 15px;">
                    <h3>Conversas Privadas</h3>
                    <ul id="lista-usuarios-chat" style="list-style: none; padding: 0;"></ul>
                </div>

                <div id="chat-interface" class="chat-container">
                    <div id="chat-mensagens" class="chat-messages">
                        </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Digite sua mensagem..." style="margin: 0;">
                        <button onclick="app.enviarMensagemChat()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modal-notificacoes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Notificações</h2>
                <button class="close-btn" onclick="app.fecharModal('modal-notificacoes')">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="lista-notificacoes" style="list-style: none; padding: 0;"></ul>
                <button class="btn-secondary" onclick="app.limparNotificacoes()" style="width: 100%; margin-top: 10px;">Marcar todas como lidas</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, update, onValue, push, query, orderByChild, limitToLast, remove, runTransaction, equalTo } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // CONFIGURAÇÃO FIREBASE (MANTIDA A ORIGINAL)
        const firebaseConfig = {
            apiKey: "AIzaSyDlK9FaFDDCk2Est9B5rlGO7a4dWHBVm8M",
            authDomain: "fanfic-283fd.firebaseapp.com",
            databaseURL: "https://fanfic-283fd-default-rtdb.firebaseio.com",
            projectId: "fanfic-283fd",
            storageBucket: "fanfic-283fd.firebasestorage.app",
            messagingSenderId: "669849579403",
            appId: "1:669849579403:web:b697d7268cfc505b4dc98e",
            measurementId: "G-VXJLPP9HNH"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const auth = getAuth(appFirebase);
        const db = getDatabase(appFirebase);

        // ESTADO GLOBAL DA APLICAÇÃO
        const state = {
            user: null,
            userData: null,
            currentStoryId: null,
            chatMode: 'global', // 'global' ou 'privado'
            privateChatId: null,
            targetUserPrivate: null
        };

        // --- SISTEMA DE TOASTS (NOTIFICAÇÕES) ---
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- FUNÇÕES DA APP ---
        window.app = {
            // -- NAVEGAÇÃO / MODAIS --
            abrirModal: (id) => {
                const modal = document.getElementById(id);
                if(modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => modal.classList.add('ativo'), 10);
                    document.body.classList.add('modal-open');
                }
            },

            fecharModal: (id) => {
                const modal = document.getElementById(id);
                if(modal) {
                    modal.classList.remove('ativo');
                    setTimeout(() => modal.style.display = 'none', 300);
                    // Só remove a classe do body se não houver outros modais abertos
                    setTimeout(() => {
                        const anyActive = document.querySelector('.modal.ativo');
                        if (!anyActive) document.body.classList.remove('modal-open');
                    }, 300);
                }
            },

            toggleSenha: (id) => {
                const input = document.getElementById(id);
                input.type = input.type === 'password' ? 'text' : 'password';
            },

            // -- AUTH --
            toggleAuthTab: (mode) => {
                const btnLogin = document.getElementById('tab-login');
                const btnCadastro = document.getElementById('tab-cadastro');
                const btnSubmit = document.getElementById('btn-submit-auth');
                
                if (mode === 'login') {
                    btnLogin.classList.remove('btn-secondary');
                    btnCadastro.classList.add('btn-secondary');
                    btnSubmit.textContent = 'Entrar';
                    btnSubmit.onclick = () => app.processarLogin();
                } else {
                    btnCadastro.classList.remove('btn-secondary');
                    btnLogin.classList.add('btn-secondary');
                    btnSubmit.textContent = 'Cadastrar';
                    btnSubmit.onclick = () => app.processarCadastro();
                }
            },

            processarLogin: async () => {
                const email = document.getElementById('auth-email').value;
                const senha = document.getElementById('auth-senha').value;
                if(!email || !senha) return showToast('Preencha todos os campos', 'error');
                
                try {
                    await signInWithEmailAndPassword(auth, email, senha);
                    showToast('Bem-vindo de volta!', 'success');
                    app.fecharModal('modal-auth');
                } catch (e) {
                    showToast('Erro ao entrar: ' + e.message, 'error');
                }
            },

            processarCadastro: async () => {
                const email = document.getElementById('auth-email').value;
                const senha = document.getElementById('auth-senha').value;
                if(senha.length < 6) return showToast('A senha deve ter no mínimo 6 caracteres', 'error');

                try {
                    const cred = await createUserWithEmailAndPassword(auth, email, senha);
                    // Criar perfil base
                    await set(ref(db, 'usuarios/' + cred.user.uid), {
                        nome: email.split('@')[0],
                        fotoUrl: 'https://ui-avatars.com/api/?background=random&name=' + email,
                        descricao: 'Novo membro do Café.',
                        pontos: 0
                    });
                    showToast('Conta criada com sucesso!', 'success');
                    app.fecharModal('modal-auth');
                } catch (e) {
                    showToast('Erro ao cadastrar: ' + e.message, 'error');
                }
            },

            logout: async () => {
                await signOut(auth);
                state.user = null;
                state.userData = null;
                showToast('Você saiu da conta.');
                renderInterface();
            },

            // -- PERFIL --
            abrirMeuPerfil: () => {
                if(!state.user) return app.abrirModal('modal-auth');
                app.carregarPerfil(state.user.uid);
            },

            abrirPerfilPublico: (uid) => {
                app.carregarPerfil(uid);
            },

            carregarPerfil: async (uid) => {
                const isMe = state.user && state.user.uid === uid;
                
                // Skeleton loading
                app.abrirModal('modal-perfil');
                document.getElementById('perfil-nome').textContent = 'Carregando...';
                
                const snap = await get(ref(db, 'usuarios/' + uid));
                const data = snap.val();
                
                if(!data) {
                    app.fecharModal('modal-perfil');
                    return showToast('Usuário não encontrado', 'error');
                }

                document.getElementById('perfil-nome').textContent = data.nome;
                document.getElementById('perfil-foto').src = data.fotoUrl || 'https://ui-avatars.com/api/?background=random&name=User';
                document.getElementById('perfil-bio').textContent = data.descricao || 'Sem descrição.';
                document.getElementById('perfil-stats').textContent = `${data.pontos || 0} Pontos de Reputação`;

                const actionsDiv = document.getElementById('perfil-actions');
                actionsDiv.innerHTML = '';

                if(isMe) {
                    const btnEdit = document.createElement('button');
                    btnEdit.className = 'btn btn-secondary';
                    btnEdit.innerHTML = '<i class="fas fa-edit"></i> Editar Perfil';
                    btnEdit.onclick = () => {
                        document.getElementById('edit-nome').value = data.nome;
                        document.getElementById('edit-foto').value = data.fotoUrl || '';
                        document.getElementById('edit-bio').value = data.descricao || '';
                        app.abrirModal('modal-editar-perfil');
                    };
                    actionsDiv.appendChild(btnEdit);
                } else if (state.user) {
                    const btnChat = document.createElement('button');
                    btnChat.className = 'btn';
                    btnChat.innerHTML = '<i class="fas fa-comment-dots"></i> Enviar Mensagem';
                    btnChat.onclick = () => app.iniciarChatPrivado(uid, data.nome);
                    actionsDiv.appendChild(btnChat);
                }

                // Carregar histórias do perfil
                app.carregarHistoriasContainer('perfil-historias', uid);
            },

            salvarPerfil: async () => {
                const nome = document.getElementById('edit-nome').value;
                const foto = document.getElementById('edit-foto').value;
                const bio = document.getElementById('edit-bio').value;

                try {
                    await update(ref(db, 'usuarios/' + state.user.uid), {
                        nome: nome,
                        fotoUrl: foto,
                        descricao: bio
                    });
                    showToast('Perfil atualizado!', 'success');
                    app.fecharModal('modal-editar-perfil');
                    app.abrirMeuPerfil(); // Reload
                } catch(e) {
                    showToast('Erro ao salvar', 'error');
                }
            },

            // -- HISTÓRIAS --
            publicarHistoria: async () => {
                if(!state.user) return;
                const titulo = document.getElementById('post-titulo').value;
                const capa = document.getElementById('post-capa').value;
                const conteudo = document.getElementById('post-conteudo').value;

                if(!titulo || !conteudo) return showToast('Título e conteúdo são obrigatórios', 'error');

                try {
                    const newRef = push(ref(db, 'historias'));
                    await set(newRef, {
                        titulo, capaUrl: capa, conteudo,
                        autorId: state.user.uid, autorNome: state.userData.nome,
                        data: Date.now(), curtidas: 0
                    });
                    showToast('História publicada!', 'success');
                    app.fecharModal('modal-criar');
                    // Limpar campos
                    document.getElementById('post-titulo').value = '';
                    document.getElementById('post-conteudo').value = '';
                } catch(e) {
                    showToast('Erro: ' + e.message, 'error');
                }
            },

            lerHistoria: async (id) => {
                state.currentStoryId = id;
                app.abrirModal('modal-leitura');
                
                const snap = await get(ref(db, 'historias/' + id));
                const h = snap.val();
                
                if(!h) return;

                document.getElementById('leitura-titulo').textContent = h.titulo;
                document.getElementById('leitura-autor').textContent = 'Por: ' + h.autorNome;
                document.getElementById('leitura-autor').onclick = () => app.abrirPerfilPublico(h.autorId);
                document.getElementById('leitura-data').textContent = new Date(h.data).toLocaleDateString();
                document.getElementById('leitura-curtidas').textContent = h.curtidas || 0;
                
                // Formatação simples do conteúdo
                let contentHTML = h.conteudo
                    .replace(/\n/g, '<br>')
                    .replace(/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/g, '<img src="$1">')
                    .replace(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/g, '<iframe width="100%" height="315" src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>');
                
                document.getElementById('conteudo-livro').innerHTML = contentHTML;

                // Gerar Estrelas
                const avaliacaoDiv = document.getElementById('area-avaliacao');
                avaliacaoDiv.innerHTML = '';
                for(let i=1; i<=5; i++) {
                    const s = document.createElement('i');
                    s.className = 'far fa-star'; // Vazio por padrão
                    s.style.color = '#FFC107';
                    s.style.margin = '0 5px';
                    s.onclick = () => app.avaliar(i);
                    avaliacaoDiv.appendChild(s);
                }
                
                // Checar se usuário já avaliou (simulação simples visual, idealmente busca do banco)
                if(h.avaliadores && state.user && h.avaliadores[state.user.uid]) {
                    app.pintarEstrelas(h.avaliadores[state.user.uid]);
                }

                // Botão de Excluir
                const adminBtn = document.getElementById('admin-buttons');
                if (state.user && state.user.uid === h.autorId) {
                    adminBtn.style.display = 'flex';
                } else {
                    adminBtn.style.display = 'none';
                }
            },

            apagarHistoria: async () => {
                if(!confirm('Tem certeza? Isso não pode ser desfeito.')) return;
                try {
                    await remove(ref(db, 'historias/' + state.currentStoryId));
                    showToast('História removida.', 'success');
                    app.fecharModal('modal-leitura');
                } catch(e) {
                    showToast('Erro ao apagar', 'error');
                }
            },

            avaliar: async (nota) => {
                if(!state.user) return app.abrirModal('modal-auth');
                if(!state.currentStoryId) return;

                const storyRef = ref(db, 'historias/' + state.currentStoryId);
                
                // Lógica simplificada de transação
                try {
                    await runTransaction(storyRef, (h) => {
                        if(h) {
                            if(!h.avaliadores) h.avaliadores = {};
                            if(h.autorId === state.user.uid) return; // Não pode avaliar a própria

                            h.avaliadores[state.user.uid] = nota;
                            // Recalcular média poderia ser feito aqui
                        }
                        return h;
                    });
                    app.pintarEstrelas(nota);
                    showToast(`Avaliado com ${nota} estrelas!`, 'success');
                } catch(e) {
                    showToast('Não foi possível avaliar.', 'error');
                }
            },

            pintarEstrelas: (nota) => {
                const estrelas = document.querySelectorAll('#area-avaliacao i');
                estrelas.forEach((s, idx) => {
                    s.className = idx < nota ? 'fas fa-star' : 'far fa-star';
                });
            },

            curtirHistoria: async () => {
                if(!state.user) return app.abrirModal('modal-auth');
                const refLikes = ref(db, `historias/${state.currentStoryId}`);
                
                await runTransaction(refLikes, (h) => {
                    if (h) {
                        if (!h.likesUsers) h.likesUsers = {};
                        if (h.likesUsers[state.user.uid]) {
                            h.curtidas--;
                            h.likesUsers[state.user.uid] = null;
                        } else {
                            h.curtidas++;
                            h.likesUsers[state.user.uid] = true;
                        }
                    }
                    return h;
                });
                // Atualização visual ocorre via listener do Firebase, não precisa manual aqui
            },
            
            compartilhar: () => {
                const url = window.location.href; // Em app real, seria link profundo
                navigator.clipboard.writeText(url).then(() => showToast('Link copiado para a área de transferência!', 'success'));
            },

            // -- COMENTÁRIOS E CHAT --
            abrirComentarios: () => {
                app.abrirModal('modal-comentarios');
                const div = document.getElementById('lista-comentarios');
                div.innerHTML = '<div class="loader"></div>';
                
                onValue(ref(db, `historias/${state.currentStoryId}/comentarios`), (snap) => {
                    div.innerHTML = '';
                    if(!snap.exists()) {
                        div.innerHTML = '<p style="text-align:center; color:gray">Seja o primeiro a comentar!</p>';
                        return;
                    }
                    snap.forEach(child => {
                        const c = child.val();
                        const bubble = document.createElement('div');
                        bubble.className = 'msg-bubble msg-left';
                        bubble.style.width = '100%';
                        bubble.style.marginBottom = '10px';
                        bubble.innerHTML = `<strong>${c.autorNome}</strong>: ${c.texto}`;
                        div.appendChild(bubble);
                    });
                    div.scrollTop = div.scrollHeight;
                });
            },

            enviarComentario: async () => {
                if(!state.user) return app.abrirModal('modal-auth');
                const txt = document.getElementById('input-comentario').value;
                if(!txt) return;
                
                await push(ref(db, `historias/${state.currentStoryId}/comentarios`), {
                    autorNome: state.userData.nome,
                    autorId: state.user.uid,
                    texto: txt,
                    data: Date.now()
                });
                document.getElementById('input-comentario').value = '';
                
                // Notificar autor da história
                const s = await get(ref(db, `historias/${state.currentStoryId}`));
                if(s.exists() && s.val().autorId !== state.user.uid) {
                    app.enviarNotificacao(s.val().autorId, `Novo comentário em "${s.val().titulo}"`);
                }
            },

            abrirChat: () => {
                if(!state.user) return app.abrirModal('modal-auth');
                app.abrirModal('modal-chat');
                app.carregarChatGlobal();
            },

            carregarChatGlobal: () => {
                state.chatMode = 'global';
                document.getElementById('chat-titulo').textContent = 'Chat Global';
                document.getElementById('chat-lista-conversas').style.display = 'none';
                document.getElementById('chat-interface').style.display = 'flex';
                
                const div = document.getElementById('chat-mensagens');
                div.innerHTML = '<div class="loader"></div>';
                
                const chatRef = query(ref(db, 'chat/global'), limitToLast(50));
                
                // Listener (precisa ser gerenciado para não duplicar, mas simplificando aqui)
                onValue(chatRef, (snap) => {
                    div.innerHTML = '';
                    snap.forEach(child => {
                        const msg = child.val();
                        app.renderMensagemChat(msg, div);
                    });
                    div.scrollTop = div.scrollHeight;
                });
            },

            alternarChatMode: () => {
                if(state.chatMode === 'global') {
                    // Mudar para seleção de privado
                    state.chatMode = 'selecao';
                    document.getElementById('chat-titulo').textContent = 'Conversas Privadas';
                    document.getElementById('chat-interface').style.display = 'none';
                    document.getElementById('chat-lista-conversas').style.display = 'block';
                    
                    // Carregar usuários (Isso deve ser otimizado em apps reais)
                    const ul = document.getElementById('lista-usuarios-chat');
                    ul.innerHTML = '<div class="loader"></div>';
                    
                    get(query(ref(db, 'usuarios'), limitToLast(20))).then(snap => {
                        ul.innerHTML = '';
                        snap.forEach(u => {
                            if(u.key !== state.user.uid) {
                                const li = document.createElement('li');
                                li.style.padding = '10px';
                                li.style.borderBottom = '1px solid #eee';
                                li.style.cursor = 'pointer';
                                li.innerHTML = `<i class="fas fa-user"></i> ${u.val().nome}`;
                                li.onclick = () => app.iniciarChatPrivado(u.key, u.val().nome);
                                ul.appendChild(li);
                            }
                        });
                    });

                } else {
                    app.carregarChatGlobal();
                }
            },

            iniciarChatPrivado: (targetId, targetName) => {
                if(!state.user) return app.abrirModal('modal-auth');
                state.chatMode = 'privado';
                state.targetUserPrivate = targetId;
                
                // ID único da conversa: menorUID_maiorUID
                const uids = [state.user.uid, targetId].sort();
                state.privateChatId = `${uids[0]}_${uids[1]}`;
                
                app.abrirModal('modal-chat');
                document.getElementById('chat-lista-conversas').style.display = 'none';
                document.getElementById('chat-interface').style.display = 'flex';
                document.getElementById('chat-titulo').textContent = `Chat com ${targetName}`;
                
                const div = document.getElementById('chat-mensagens');
                div.innerHTML = '<div class="loader"></div>';
                
                onValue(query(ref(db, `chat/privado/${state.privateChatId}`), limitToLast(50)), (snap) => {
                    div.innerHTML = '';
                    if(!snap.exists()) div.innerHTML = '<small style="text-align:center; display:block; margin-top:20px;">Inicie a conversa...</small>';
                    snap.forEach(child => app.renderMensagemChat(child.val(), div));
                    div.scrollTop = div.scrollHeight;
                });
            },

            renderMensagemChat: (msg, container) => {
                const div = document.createElement('div');
                const isMe = msg.autorId === state.user.uid;
                div.className = `msg-bubble ${isMe ? 'msg-right' : 'msg-left'}`;
                
                // Se for grupo, mostrar nome
                let nomeHtml = (state.chatMode === 'global' && !isMe) ? `<small style="font-weight:bold; display:block; font-size:0.7em; color: var(--primary)">${msg.autorNome}</small>` : '';
                
                div.innerHTML = `${nomeHtml}${msg.texto}`;
                container.appendChild(div);
            },

            enviarMensagemChat: async () => {
                const inp = document.getElementById('chat-input');
                const txt = inp.value;
                if(!txt) return;
                
                const payload = {
                    autorId: state.user.uid,
                    autorNome: state.userData.nome,
                    texto: txt,
                    timestamp: Date.now()
                };

                if(state.chatMode === 'global') {
                    await push(ref(db, 'chat/global'), payload);
                } else if (state.chatMode === 'privado') {
                    await push(ref(db, `chat/privado/${state.privateChatId}`), payload);
                    // Notificar o outro
                    app.enviarNotificacao(state.targetUserPrivate, `Nova mensagem de ${state.userData.nome}`);
                }
                inp.value = '';
            },

            // -- NOTIFICAÇÕES --
            enviarNotificacao: async (uidDestino, texto) => {
                push(ref(db, `notificacoes/${uidDestino}`), {
                    texto, lida: false, data: Date.now()
                });
            },

            abrirNotificacoes: () => {
                if(!state.user) return;
                app.abrirModal('modal-notificacoes');
                // Carregar lista já é feito pelo listener global
            },
            
            limparNotificacoes: async () => {
                // Marcar como lidas (update complexo omitido, limpando tudo visualmente)
                if(!state.user) return;
                // Exemplo simples: remover todas
                await remove(ref(db, `notificacoes/${state.user.uid}`));
            },

            // -- UTILITÁRIOS --
            carregarHistoriasContainer: (containerId, filtroAutorId = null) => {
                const container = document.getElementById(containerId);
                let q = query(ref(db, 'historias'), orderByChild('data'));
                
                if (filtroAutorId) {
                    q = query(ref(db, 'historias'), orderByChild('autorId'), equalTo(filtroAutorId));
                }

                onValue(q, (snap) => {
                    container.innerHTML = '';
                    if(!snap.exists()) {
                        container.innerHTML = '<p style="color:gray; width:100%">Nenhuma história encontrada.</p>';
                        return;
                    }

                    const list = [];
                    snap.forEach(c => list.push({key: c.key, ...c.val()}));
                    // Inverter ordem (mais recentes primeiro) se não houver filtro complexo
                    if(!filtroAutorId) list.reverse();

                    list.forEach(h => {
                        const card = document.createElement('div');
                        card.className = 'historia-card';
                        card.onclick = () => app.lerHistoria(h.key);
                        card.innerHTML = `
                            <img src="${h.capaUrl || 'https://via.placeholder.com/300x150?text=Capa'}" loading="lazy">
                            <div class="card-content">
                                <h4>${h.titulo}</h4>
                                <p>por ${h.autorNome}</p>
                                <div class="card-footer">
                                    <span><i class="fas fa-heart"></i> ${h.curtidas || 0}</span>
                                    <span>Ver mais</span>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                });
            }
        };

        // --- INICIALIZAÇÃO ---
        function renderInterface() {
            const area = document.getElementById('botoes-acesso');
            if (state.user) {
                // Logado
                area.innerHTML = `
                    <button onclick="app.abrirModal('modal-criar')"><i class="fas fa-plus"></i> Escrever</button>
                    <button onclick="app.abrirChat()" class="btn-secondary"><i class="fas fa-comments"></i> Chat</button>
                    <button onclick="app.abrirMeuPerfil()" class="btn-secondary"><i class="fas fa-user"></i> Perfil</button>
                    <button onclick="app.logout()" class="btn-danger"><i class="fas fa-sign-out-alt"></i></button>
                    <button onclick="document.body.classList.toggle('dark-mode')" class="btn-secondary" style="margin-left:auto"><i class="fas fa-moon"></i></button>
                `;
            } else {
                // Deslogado
                area.innerHTML = `
                    <button onclick="app.abrirModal('modal-auth'); app.toggleAuthTab('login')">Entrar</button>
                    <button onclick="app.abrirModal('modal-auth'); app.toggleAuthTab('cadastro')" class="btn-secondary">Cadastrar</button>
                    <button onclick="document.body.classList.toggle('dark-mode')" class="btn-secondary" style="margin-left:auto"><i class="fas fa-moon"></i></button>
                `;
            }
        }

        // --- LOAD ---
        onAuthStateChanged(auth, async (user) => {
            state.user = user;
            if (user) {
                // Buscar dados extras
                const snap = await get(ref(db, 'usuarios/' + user.uid));
                state.userData = snap.val();
                
                // Monitorar Notificações
                onValue(ref(db, `notificacoes/${user.uid}`), (snap) => {
                    const count = snap.size;
                    const badge = document.getElementById('contador-notificacoes');
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'block' : 'none';
                    
                    // Renderizar lista na modal
                    const ul = document.getElementById('lista-notificacoes');
                    ul.innerHTML = '';
                    if(!snap.exists()) ul.innerHTML = '<li>Sem notificações</li>';
                    snap.forEach(c => {
                        const li = document.createElement('li');
                        li.style.padding = '10px';
                        li.style.borderBottom = '1px solid #eee';
                        li.innerHTML = c.val().texto;
                        ul.appendChild(li);
                    });
                });
            }
            renderInterface();
        });

        // Carregar conteúdo inicial
        app.carregarHistoriasContainer('lista-publicacoes');
        
        // Destaques (Simulação: pegar as últimas 3)
        // Em produção seria orderByChild('curtidas').limitToLast(3)
        onValue(query(ref(db, 'historias'), limitToLast(3)), (snap) => {
            const div = document.getElementById('destaques-container');
            div.innerHTML = '';
            snap.forEach(c => {
                const h = c.val();
                div.innerHTML += `
                <div class="historia-card" onclick="app.lerHistoria('${c.key}')" style="background: linear-gradient(45deg, var(--primary), var(--primary-dark)); color: white;">
                    <div class="card-content">
                        <h4 style="color:white">${h.titulo}</h4>
                        <p style="color: #ddd">${h.autorNome}</p>
                        <small>Destaque <i class="fas fa-star"></i></small>
                    </div>
                </div>`;
            });
        });

        // Inicializar botões corretamente ao carregar a página
        renderInterface();
    </script>
</body>
</html>
